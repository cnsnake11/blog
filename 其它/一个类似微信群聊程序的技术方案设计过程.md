# 一个类似微信群聊程序的技术方案设计过程

本次项目的技术方案抉择很有趣也很具有典型性，印证了没有最好的技术，只有最适合的技术，所以在此进行记录。

# 项目背景

公司新立的一个项目，项目还处于保密阶段，他的具体背景在这不太方便说，简单用技术语言概括一下就是，要做一个类似于微信群聊的东西。

项目周期：一个月左右。

# 思维历程

即时通讯类程序最重要的特征就是需要有服务器推送的能力，传统的BS结构的web应用，请求都是由浏览器发出，服务响应返回结果，而即时通讯类程序要求服务器有主动给浏览器or客户端发送请求的能力。

## 长连接

从产品经理那拿到这个需求之后，我们第一个反应就是使用长连接技术，因为长连接技术是做即时通讯类程序比较成熟比较完美的解决方案，但是我们公司技术架构平台并没有这块的支撑经验，也没有相应的配套技术框架，结合一个月的项目周期来考虑，风险确实较大。

所以我们就想到了目前市场上很多云平台都提供了即时通讯的解决方案，可不可以使用现成的解决方案来降低我们的风险。在调研了一圈后发现，还是存在两个问题，第一是花钱，一般都是按流量收费，这个可能还需要领导审批一下，第二是风险虽然降低，但是还是有风险，并且风险不可控，担心平台方如果响应不及时或者有不可见坑，在这么短的工期下可能没有调整的空间。

还有没有更佳的解决办法呢。

## 轮询

轮询是使用间隔固定时间的短连接来和服务器保持联系的一种手段，他有2个很致命的弱点。

第一是做不到消息的即时性，因为客户端需要间隔一个时间段才向服务器发送一次请求，那么理论上，客户端接收到的消息会有最长等于间隔时间的延迟。可以通过调小间隔时间来降低延迟。

第二是对服务器的性能损耗较大（相比较于长连接技术），客户端并不知道服务器有没有新消息，永远都是固定时间后就发送一次请求，其中会有一大部分请求返回值都是空，是浪费的，当使用用户很多的情况下，这些请求也是比较密集的，对服务器产生一定的压力。可以通过调大间隔时间来减小压力。

轮询方案的优点是无需调整公司现有的技术架构体系，就可以很好的进行支撑，开发成本和风险都是最低的。

那么有没有办法解决掉上述的两个弱点呢。

关于消息及时性，属于业务范畴的问题，主要看业务场景的容忍度，所以我们和产品经理进行了充分的沟通，很幸运，本次的业务对及时性的要求并不高，最长都可以容忍一分钟的延迟，ok，第一个问题竟然已经不是问题了。

关于服务器性能的损耗，我们又与后台架构的同学交流了服务器对瞬时并发的承载能力，与产品经理交流了业务场景可能参与的用户数量，后台架构同学按照最大的用户使用数量，给我们的建议是间隔时间设置为5秒服务器集群都应该没有任何问题，同时业务的最长容忍时间是1分钟，我们拥有了很大的调整空间，心中的一块石头落了地，第二个问题竟然也不是问题了。

# 设计方案结论

结论显而易见，在考虑到开发成本，业务场景，工期要求等综合因素后，我们选择了轮询的解决方案。同时，针对轮询方案的弱点，我们还设计了2个补救措施。

## 延迟消息的显示方案

因为轮询的特点，一次请求可能带回来很多条新消息，我们会立刻显示这些消息中的第一条，其它的消息按照与第一条时间差逐条显示。这样，从用户看来，还是逐条显示的，好像是刚发的一样，让用户感觉不到是轮询。

## 服务器压力缓解方案

我们把间隔时间放到后台来配置，每一次的轮询结果里，都会把间隔时间带回来，前端使用这个最新的间隔时间来启动下一次的轮询，这样我们就可以动态的调整所有客户端的间隔时间，当服务器压力过大或者过小的时候，我们都可以随时调整这个间隔时间，同时保证服务器的稳定性和用户的良好体验。

# 总结思考

其实在这次选型的过程中，轮询方案是最先想到也是最先抛弃的，因为他的弱点太显而易见了，而且技术上是不可解决的，但是，戏剧性的是通过我们和产品经理对业务场景的深层次讨论，发现轮询才是最适合的解决方案，是性价比最高的，而且没有什么坑。

所以，根据上述过程，总结了一句话就是，技术方案设计一定要结合业务场景进行，脱离业务场景的技术都是纸上谈兵，没有最好的技术方案，只有最适合的技术方案。


